name: ðŸš€ Deploy to AWS S3 + CloudFront v1

# This workflow is used to deploy the React Native web app to AWS S3 and CloudFront
on:
  push:
        branches: [ '**' ]
  pull_request:
        branches: [ '**' ]
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  AWS_REGION: us-east-1
  S3_BUCKET_STAGING: medi-supply-staging
  S3_BUCKET_PRODUCTION: medi-supply-production
  CLOUDFRONT_DISTRIBUTION_STAGING: E1234567890STAGING
  CLOUDFRONT_DISTRIBUTION_PRODUCTION: E0987654321PROD

jobs:
 

  # Job para construir la aplicaciÃ³n web
  build:
    name: ðŸ—ï¸ Build Web App
    runs-on: ubuntu-latest

    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build for web
      run: npm run build:production
      
    - name: ðŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: dist/
        retention-days: 7

  # Job para desplegar a staging
  deploy-staging:
    name: ðŸŒ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: web-build
        path: dist/
        
    - name: ðŸ”§ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ðŸš€ Deploy to S3
      run: |
        aws s3 sync dist/ s3://${{ env.S3_BUCKET_STAGING }} --delete --cache-control "public, max-age=31536000"
        
    - name: ðŸ—‚ï¸ Upload index.html with no-cache
      run: |
        aws s3 cp dist/index.html s3://${{ env.S3_BUCKET_STAGING }}/index.html --cache-control "no-cache, no-store, must-revalidate"
        
    - name: âš¡ Invalidate CloudFront
      run: |
        aws cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_STAGING }} --paths "/*"
        
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## ðŸŒ Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: Staging" >> $GITHUB_STEP_SUMMARY
        echo "**S3 Bucket**: ${{ env.S3_BUCKET_STAGING }}" >> $GITHUB_STEP_SUMMARY
        echo "**CloudFront Distribution**: ${{ env.CLOUDFRONT_DISTRIBUTION_STAGING }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY

  # Job para desplegar a producciÃ³n
  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: web-build
        path: dist/
        
    - name: ðŸ”§ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ðŸš€ Deploy to S3
      run: |
        aws s3 sync dist/ s3://${{ env.S3_BUCKET_PRODUCTION }} --delete --cache-control "public, max-age=31536000"
        
    - name: ðŸ—‚ï¸ Upload index.html with no-cache
      run: |
        aws s3 cp dist/index.html s3://${{ env.S3_BUCKET_PRODUCTION }}/index.html --cache-control "no-cache, no-store, must-revalidate"
        
    - name: âš¡ Invalidate CloudFront
      run: |
        aws cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_PRODUCTION }} --paths "/*"
        
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## ðŸš€ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
        echo "**S3 Bucket**: ${{ env.S3_BUCKET_PRODUCTION }}" >> $GITHUB_STEP_SUMMARY
        echo "**CloudFront Distribution**: ${{ env.CLOUDFRONT_DISTRIBUTION_PRODUCTION }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY

  # Job para notificaciones
  notify:
    name: ðŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: ðŸ“¢ Deployment Notification
      run: |
        echo "## ðŸ“¢ Deployment Notification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Did you know?" >> $GITHUB_STEP_SUMMARY
        echo "- This deployment includes 27 passing unit tests" >> $GITHUB_STEP_SUMMARY
        echo "- All utility functions are properly tested" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage reports are available in the artifacts" >> $GITHUB_STEP_SUMMARY
