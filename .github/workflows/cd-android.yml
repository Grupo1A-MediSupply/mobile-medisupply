name: CD Android

on:
  push:
    #branches: [ main, develop, feature/auth, release ]
  workflow_run:
    workflows: ["CI Mobile"]
    types: [completed]
  workflow_dispatch: # Permite ejecución manual

jobs:
  wait-for-ci:
    runs-on: ubuntu-latest
    outputs:
      ci-success: ${{ steps.set-output.outputs.ci-success }}
    steps:
      - name: Wait for CI Mobile workflow to complete
        id: wait-ci
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const ref = context.ref;
            const branch = ref.replace('refs/heads/', '');
            const workflowFileName = '.github/workflows/ci-mobile.yml';
            
            console.log(`Waiting for CI Mobile workflow to complete on ${branch}...`);
            
            // Wait a bit for the CI workflow to start
            console.log('Waiting 15 seconds for CI workflow to start...');
            await new Promise(resolve => setTimeout(resolve, 15000));
            
            // Wait for the workflow run to complete
            let attempts = 0;
            const maxAttempts = 60; // 10 minutes max (60 * 10 seconds)
            const commitSha = context.sha;
            
            while (attempts < maxAttempts) {
              // Get the latest workflow runs for this workflow file
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflowFileName,
                branch: branch,
                per_page: 10
              });
              
              if (runs.data.workflow_runs.length > 0) {
                // Find the run for this specific commit
                const workflowRun = runs.data.workflow_runs.find(
                  run => run.head_sha === commitSha
                );
                
                if (workflowRun) {
                  console.log(`Found workflow run for commit ${commitSha.substring(0, 7)}: status=${workflowRun.status}, conclusion=${workflowRun.conclusion || 'pending'}`);
                  
                  if (workflowRun.status === 'completed') {
                    if (workflowRun.conclusion === 'success') {
                      console.log('✅ CI workflow completed successfully!');
                      core.setOutput('ci-success', 'true');
                      return;
                    } else {
                      console.log(`❌ CI workflow failed with conclusion: ${workflowRun.conclusion}`);
                      core.setOutput('ci-success', 'false');
                      core.setFailed(`CI workflow failed with conclusion: ${workflowRun.conclusion}`);
                      return;
                    }
                  } else {
                    console.log(`Workflow still running (status: ${workflowRun.status}), waiting...`);
                  }
                } else {
                  console.log(`No workflow run found for commit ${commitSha.substring(0, 7)} yet, waiting...`);
                }
              } else {
                console.log('No workflow runs found yet, waiting...');
              }
              
              attempts++;
              if (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
              }
            }
            
            core.setFailed('Timeout waiting for CI workflow to complete');
            core.setOutput('ci-success', 'false');
      
      - name: Set output
        id: set-output
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "ci-success=${{ steps.wait-ci.outputs.ci-success }}" >> $GITHUB_OUTPUT
          else
            echo "ci-success=true" >> $GITHUB_OUTPUT
          fi

  build-android:
    runs-on: ubuntu-latest
    needs: wait-for-ci
    # Solo correr si:
    # - Es ejecución manual (workflow_dispatch), O
    # - El CI terminó exitosamente Y es una rama permitida (workflow_run), O
    # - Es push Y el CI terminó exitosamente (wait-for-ci)
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' && 
       (github.event.workflow_run.head_branch == 'main' || 
        github.event.workflow_run.head_branch == 'develop' || 
        github.event.workflow_run.head_branch == 'feature/auth' || 
        github.event.workflow_run.head_branch == 'release' ||
        startsWith(github.event.workflow_run.head_branch, 'feature/auth/'))) ||
      (github.event_name == 'push' && needs.wait-for-ci.outputs.ci-success == 'true')

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref_name || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          # o: yarn install --frozen-lockfile

      - name: Install Expo CLI
        run: |
          npm install -g expo-cli@latest

      - name: Generate native Android project
        run: |
          npx expo prebuild --platform android --clean

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Aquí podrías restaurar tu keystore desde secrets si quisieras firmar
      # - name: Decode keystore
      #   run: |
      #     echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/my-release-key.keystore
      #   env:
      #     ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Build Android release APK
        working-directory: android
        run: |
          ./gradlew assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/release/*.apk
