name: CD Android

on:
  push:
    branches: [ main, develop, feature/auth ]
  workflow_run:
    workflows: ["CI Mobile"]
    types: [completed]
  workflow_dispatch: # Permite ejecución manual

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug info
        run: |
          echo "=== DEBUG INFO ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Current ref: ${{ github.ref }}"
          echo "Current ref name: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo ""
            echo "=== WORKFLOW_RUN INFO ==="
            echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
            echo "Workflow run head branch: ${{ github.event.workflow_run.head_branch }}"
            echo "Workflow run status: ${{ github.event.workflow_run.status }}"
            echo ""
            echo "=== CONDITION CHECK ==="
            if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
              echo "✅ CI was successful"
            else
              echo "❌ CI was NOT successful (conclusion: ${{ github.event.workflow_run.conclusion }})"
            fi
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            echo "Branch: $BRANCH"
            if [ "$BRANCH" == "main" ] || [ "$BRANCH" == "develop" ] || [ "$BRANCH" == "feature/auth" ] || [[ "$BRANCH" == feature/auth/* ]]; then
              echo "✅ Branch is allowed"
            else
              echo "❌ Branch is NOT allowed"
            fi
          fi
  
  wait-for-ci:
    runs-on: ubuntu-latest
    outputs:
      ci-success: ${{ steps.set-output.outputs.ci-success }}
    steps:
      - name: Wait for CI Mobile workflow to complete
        id: wait-ci
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const ref = context.ref;
            const workflowName = 'CI Mobile';
            
            console.log(`Waiting for workflow "${workflowName}" to complete on ${ref}...`);
            
            // Get workflow ID
            const workflows = await github.rest.actions.listWorkflowsForRepo({
              owner,
              repo
            });
            
            const ciWorkflow = workflows.data.workflows.find(
              w => w.name === workflowName && w.state === 'active'
            );
            
            if (!ciWorkflow) {
              throw new Error(`Workflow "${workflowName}" not found`);
            }
            
            console.log(`Found workflow ID: ${ciWorkflow.id}`);
            
            // Wait for the workflow run to complete
            let workflowRun = null;
            let attempts = 0;
            const maxAttempts = 60; // 10 minutes max (60 * 10 seconds)
            
            while (attempts < maxAttempts) {
              // Get the latest workflow run for this ref
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: ciWorkflow.id,
                branch: ref.replace('refs/heads/', ''),
                per_page: 1
              });
              
              if (runs.data.workflow_runs.length > 0) {
                workflowRun = runs.data.workflow_runs[0];
                
                console.log(`Workflow run status: ${workflowRun.status}, conclusion: ${workflowRun.conclusion || 'pending'}`);
                
                if (workflowRun.status === 'completed') {
                  if (workflowRun.conclusion === 'success') {
                    console.log('✅ CI workflow completed successfully!');
                    core.setOutput('ci-success', 'true');
                    return;
                  } else {
                    console.log(`❌ CI workflow failed with conclusion: ${workflowRun.conclusion}`);
                    core.setOutput('ci-success', 'false');
                    core.setFailed(`CI workflow failed with conclusion: ${workflowRun.conclusion}`);
                    return;
                  }
                }
              } else {
                console.log('No workflow run found yet, waiting...');
              }
              
              attempts++;
              if (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
              }
            }
            
            core.setFailed('Timeout waiting for CI workflow to complete');
            core.setOutput('ci-success', 'false');
      
      - name: Set output
        id: set-output
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "ci-success=${{ steps.wait-ci.outputs.ci-success }}" >> $GITHUB_OUTPUT
          else
            echo "ci-success=true" >> $GITHUB_OUTPUT
          fi

  build-android:
    runs-on: ubuntu-latest
    needs: 
      - debug
      - wait-for-ci
    # Solo correr si:
    # - Es ejecución manual (workflow_dispatch), O
    # - El CI terminó exitosamente Y es una rama permitida (workflow_run), O
    # - Es push Y el CI terminó exitosamente (wait-for-ci)
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' && 
       (github.event.workflow_run.head_branch == 'main' || 
        github.event.workflow_run.head_branch == 'develop' || 
        github.event.workflow_run.head_branch == 'feature/auth' || 
        startsWith(github.event.workflow_run.head_branch, 'feature/auth/'))) ||
      (github.event_name == 'push' && needs.wait-for-ci.outputs.ci-success == 'true')

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref_name || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          # o: yarn install --frozen-lockfile

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Aquí podrías restaurar tu keystore desde secrets si quisieras firmar
      # - name: Decode keystore
      #   run: |
      #     echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/my-release-key.keystore
      #   env:
      #     ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Build Android release APK
        working-directory: android
        run: |
          ./gradlew assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/release/*.apk
