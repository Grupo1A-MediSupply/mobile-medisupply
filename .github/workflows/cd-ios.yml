name: CD iOS

on:
  push:
    branches: [ main, develop, feature/auth, feature/predevelop, release ]
  workflow_run:
    workflows: ["CI Mobile"]
    types: [completed]
  workflow_dispatch: # Permite ejecución manual

jobs:
  wait-for-ci:
    runs-on: ubuntu-latest
    outputs:
      ci-success: ${{ steps.set-output.outputs.ci-success }}
    steps:
      - name: Wait for CI Mobile workflow to complete
        id: wait-ci
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const ref = context.ref;
            const branch = ref.replace('refs/heads/', '');
            const workflowFileName = '.github/workflows/ci-mobile.yml';
            
            console.log(`Waiting for CI Mobile workflow to complete on ${branch}...`);
            
            // Wait a bit for the CI workflow to start
            console.log('Waiting 15 seconds for CI workflow to start...');
            await new Promise(resolve => setTimeout(resolve, 15000));
            
            // Wait for the workflow run to complete
            let attempts = 0;
            const maxAttempts = 60; // 10 minutes max (60 * 10 seconds)
            const commitSha = context.sha;
            
            while (attempts < maxAttempts) {
              // Get the latest workflow runs for this workflow file
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflowFileName,
                branch: branch,
                per_page: 10
              });
              
              if (runs.data.workflow_runs.length > 0) {
                // Find the run for this specific commit
                const workflowRun = runs.data.workflow_runs.find(
                  run => run.head_sha === commitSha
                );
                
                if (workflowRun) {
                  console.log(`Found workflow run for commit ${commitSha.substring(0, 7)}: status=${workflowRun.status}, conclusion=${workflowRun.conclusion || 'pending'}`);
                  
                  if (workflowRun.status === 'completed') {
                    if (workflowRun.conclusion === 'success') {
                      console.log('✅ CI workflow completed successfully!');
                      core.setOutput('ci-success', 'true');
                      return;
                    } else {
                      console.log(`❌ CI workflow failed with conclusion: ${workflowRun.conclusion}`);
                      core.setOutput('ci-success', 'false');
                      core.setFailed(`CI workflow failed with conclusion: ${workflowRun.conclusion}`);
                      return;
                    }
                  } else {
                    console.log(`Workflow still running (status: ${workflowRun.status}), waiting...`);
                  }
                } else {
                  console.log(`No workflow run found for commit ${commitSha.substring(0, 7)} yet, waiting...`);
                }
              } else {
                console.log('No workflow runs found yet, waiting...');
              }
              
              attempts++;
              if (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
              }
            }
            
            core.setFailed('Timeout waiting for CI workflow to complete');
            core.setOutput('ci-success', 'false');
      
      - name: Set output
        id: set-output
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "ci-success=${{ steps.wait-ci.outputs.ci-success }}" >> $GITHUB_OUTPUT
          else
            echo "ci-success=true" >> $GITHUB_OUTPUT
          fi

  build-ios:
    runs-on: macos-latest    # iOS necesita macOS sí o sí
    needs: wait-for-ci
    # Solo correr si:
    # - Es ejecución manual (workflow_dispatch), O
    # - El CI terminó exitosamente Y es una rama permitida (workflow_run), O
    # - Es push Y el CI terminó exitosamente (wait-for-ci)
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' && 
       (github.event.workflow_run.head_branch == 'main' || 
        github.event.workflow_run.head_branch == 'develop' || 
        github.event.workflow_run.head_branch == 'feature/auth' || 
        github.event.workflow_run.head_branch == 'release' ||
        startsWith(github.event.workflow_run.head_branch, 'feature/auth/'))) ||
      (github.event_name == 'push' && needs.wait-for-ci.outputs.ci-success == 'true')

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref_name || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          # o yarn install --frozen-lockfile

      - name: Install Expo CLI
        run: |
          npm install -g @expo/cli@latest

      - name: Generate native iOS project
        run: |
          npx expo prebuild --platform ios --clean
          
          # Verificar que se generó el directorio ios
          if [ ! -d "ios" ]; then
            echo "Error: El directorio ios no se generó"
            exit 1
          fi
          
          # Verificar que existe un workspace (el workspace se genera después de pod install)
          echo "Directorio ios generado correctamente"
          ls -la ios/ | head -20

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: |
          # Verificar que Podfile existe
          if [ ! -f "Podfile" ]; then
            echo "Error: Podfile no encontrado"
            ls -la
            exit 1
          fi
          
          # Instalar pods
          pod install --repo-update
          
          # Verificar que se generó el workspace
          WORKSPACE_CHECK=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1)
          if [ -z "$WORKSPACE_CHECK" ]; then
            echo "Error: Workspace no se generó después de pod install"
            echo "Archivos en el directorio:"
            ls -la
            exit 1
          fi
          echo "✅ Workspace generado: $(basename "$WORKSPACE_CHECK")"

      - name: Build iOS .ipa (for physical devices)
        working-directory: ios
        run: |
          # Verificar qué workspace se generó (buscar solo directorios .xcworkspace)
          WORKSPACE_PATH=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1)
          if [ -z "$WORKSPACE_PATH" ]; then
            echo "Error: No se encontró ningún .xcworkspace"
            echo "Archivos en el directorio:"
            ls -la
            echo "Buscando en subdirectorios:"
            find . -name "*.xcworkspace" -type d
            exit 1
          fi
          
          # Obtener solo el nombre del workspace (sin la ruta)
          WORKSPACE_NAME=$(basename "$WORKSPACE_PATH")
          
          # Extraer el nombre del scheme del workspace (sin la extensión .xcworkspace)
          SCHEME=$(basename "$WORKSPACE_NAME" .xcworkspace)
          echo "Workspace encontrado: $WORKSPACE_PATH"
          echo "Usando workspace: $WORKSPACE_NAME"
          echo "Usando scheme: $SCHEME"
          
          # Verificar que el workspace existe antes de compilar
          if [ ! -d "$WORKSPACE_NAME" ]; then
            echo "Error: El workspace $WORKSPACE_NAME no existe"
            ls -la
            exit 1
          fi
          
          # Listar los schemes disponibles para debugging
          echo "Schemes disponibles:"
          xcodebuild -workspace "$WORKSPACE_NAME" -list || true
          
          # Compilar el .app para dispositivos físicos (sin certificados)
          echo "Compilando para dispositivos físicos..."
          if ! xcodebuild \
            -workspace "$WORKSPACE_NAME" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build/DerivedData-iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build; then
            echo "Error: La compilación falló"
            exit 1
          fi
          echo "✅ Compilación exitosa"

          # Encontrar el .app compilado para iphoneos
          APP_PATH=$(find build/DerivedData-iphoneos -name "*.app" -type d | head -1)
          
          if [ -z "$APP_PATH" ]; then
            echo "Error: No se encontró el archivo .app compilado para iphoneos"
            echo "Buscando en: build/DerivedData-iphoneos"
            find build/DerivedData-iphoneos -type d -name "*.app" 2>/dev/null || echo "No se encontraron archivos .app"
            exit 1
          fi

          echo "App para dispositivos físicos encontrada en: $APP_PATH"
          
          # Crear directorio Payload
          mkdir -p build/Payload
          
          # Copiar el .app al directorio Payload
          cp -R "$APP_PATH" build/Payload/
          
          # Crear el .ipa
          cd build
          zip -r medisupply.ipa Payload
          rm -rf Payload
          cd ..
          
          echo "✅ IPA creado en: build/medisupply.ipa"

      - name: Build iOS .app (for simulator)
        working-directory: ios
        run: |
          # Reutilizar el workspace del paso anterior (ya está verificado)
          WORKSPACE_PATH=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1)
          WORKSPACE_NAME=$(basename "$WORKSPACE_PATH")
          SCHEME=$(basename "$WORKSPACE_NAME" .xcworkspace)
          
          echo "Usando workspace: $WORKSPACE_NAME"
          echo "Usando scheme: $SCHEME"
          
          # Compilar el .app para simulador
          echo "Compilando para simulador..."
          if ! xcodebuild \
            -workspace "$WORKSPACE_NAME" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphonesimulator \
            -derivedDataPath build/DerivedData-simulator \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build; then
            echo "Error: La compilación del simulador falló"
            exit 1
          fi
          echo "✅ Compilación del simulador exitosa"

          # Encontrar el .app compilado para simulador
          SIM_APP_PATH=$(find build/DerivedData-simulator -name "*.app" -type d | head -1)
          
          if [ -z "$SIM_APP_PATH" ]; then
            echo "Error: No se encontró el archivo .app compilado para simulador"
            echo "Buscando en: build/DerivedData-simulator"
            find build/DerivedData-simulator -type d -name "*.app" 2>/dev/null || echo "No se encontraron archivos .app"
            exit 1
          fi

          echo "App para simulador encontrada en: $SIM_APP_PATH"
          
          # Copiar el .app al directorio build para fácil acceso
          cp -R "$SIM_APP_PATH" build/medisupply-simulator.app
          
          echo "✅ App para simulador creada en: build/medisupply-simulator.app"

      - name: Verify artifacts before upload
        working-directory: ios
        run: |
          if [ ! -f "build/medisupply.ipa" ]; then
            echo "Error: El archivo medisupply.ipa no existe"
            ls -la build/
            exit 1
          fi
          
          if [ ! -d "build/medisupply-simulator.app" ]; then
            echo "Error: El archivo medisupply-simulator.app no existe"
            ls -la build/
            exit 1
          fi
          
          echo "✅ Todos los artifacts están listos para subir"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/medisupply.ipa
          if-no-files-found: error

      - name: Upload Simulator App artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-app
          path: ios/build/medisupply-simulator.app
          if-no-files-found: error
